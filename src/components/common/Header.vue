<template>
  <v-app-bar app floating elevation="2" :class="{ 'mt-2': true, scrolled: isScrolled }" color="transparent">
    <div class="d-flex align-center">
      <v-app-bar-title class="font-weight-bold text-white clickable-title" @click="goToDashboard"> WMTHIS </v-app-bar-title>
    </div>

    <div class="d-none d-md-flex">
      <!-- ëŒ€ì‹œë³´ë“œ ë©”ë‰´ -->
      <v-menu open-on-click offset-y>
        <template v-slot:activator="{ props }">
          <v-btn
            text
            class="mx-1 header-menu first-menu custom-btn"
            :class="{ 'active-menu': activeMenu === 'ëŒ€ì‹œë³´ë“œ' }"
            v-bind="props"
            @click="goToDashboard"
          >
            ëŒ€ì‹œë³´ë“œ
          </v-btn>
        </template>
      </v-menu>

      <!-- ë©”ë‰´ ê´€ë¦¬ -->
      <v-menu open-on-click offset-y>
        <template v-slot:activator="{ props }">
          <v-btn
            text
            class="mx-1 header-menu custom-btn"
            :class="{ 'active-menu': activeMenu === 'ë©”ë‰´ ê´€ë¦¬' }"
            v-bind="props"
            @click="setActiveMenu('ë©”ë‰´ ê´€ë¦¬')"
          >
            ë©”ë‰´ ê´€ë¦¬
          </v-btn>
        </template>
        <v-list class="dropdown-list">
          <v-list-item
            v-for="(item, index) in ['ë©”ë‰´ ê´€ë¦¬', 'ì¹´í…Œê³ ë¦¬ ê´€ë¦¬', 'ì˜µì…˜ ê´€ë¦¬']"
            :key="index"
            @click="setActiveDropdown('ë©”ë‰´ ê´€ë¦¬', item)"
            :class="{ 'active-dropdown': activeDropdowns['ë©”ë‰´ ê´€ë¦¬'] === item }"
          >
            <v-list-item-title>{{ item }}</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>

      <!-- ì¬ê³  ê´€ë¦¬ -->
      <v-menu open-on-click offset-y>
        <template v-slot:activator="{ props }">
          <v-btn
            text
            class="mx-1 header-menu custom-btn"
            :class="{ 'active-menu': activeMenu === 'ì¬ê³  ê´€ë¦¬' }"
            v-bind="props"
            @click="setActiveMenu('ì¬ê³  ê´€ë¦¬')"
          >
            ì¬ê³  ê´€ë¦¬
          </v-btn>
        </template>
        <v-list class="dropdown-list">
          <v-list-item
            v-for="(item, index) in ['ì¬ê³  ì •ë³´', 'ì¬ê³  ì…ê³ ']"
            :key="index"
            @click="setActiveDropdown('ì¬ê³  ê´€ë¦¬', item)"
            :class="{ 'active-dropdown': activeDropdowns['ì¬ê³  ê´€ë¦¬'] === item }"
          >
            <v-list-item-title>{{ item }}</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>

      <!-- ê°€ê²Œ ë¶„ì„ -->
      <v-menu open-on-click offset-y>
        <template v-slot:activator="{ props }">
          <v-btn
            text
            class="mx-1 header-menu custom-btn"
            :class="{ 'active-menu': activeMenu === 'ê°€ê²Œ ë¶„ì„' }"
            v-bind="props"
            @click="setActiveMenu('ê°€ê²Œ ë¶„ì„')"
          >
            ê°€ê²Œ ë¶„ì„
          </v-btn>
        </template>
        <v-list class="dropdown-list">
          <v-list-item
            v-for="(item, index) in ['ë§¤ì¶œ ë¶„ì„', 'ë©”ë‰´ ë¶„ì„', 'ì¬ê³  ë¶„ì„']"
            :key="index"
            @click="setActiveDropdown('ê°€ê²Œ ë¶„ì„', item)"
            :class="{ 'active-dropdown': activeDropdowns['ê°€ê²Œ ë¶„ì„'] === item }"
          >
            <v-list-item-title>{{ item }}</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>

      <!-- ì»¤ë®¤ë‹ˆí‹° -->
      <v-menu open-on-click offset-y>
        <template v-slot:activator="{ props }">
          <v-btn
            text
            class="mx-1 header-menu custom-btn"
            :class="{ 'active-menu': activeMenu === 'ì»¤ë®¤ë‹ˆí‹°' }"
            v-bind="props"
            @click="setActiveMenu('ì»¤ë®¤ë‹ˆí‹°')"
          >
            ì»¤ë®¤ë‹ˆí‹°
          </v-btn>
        </template>
        <v-list class="dropdown-list">
          <v-list-item
            v-for="(item, index) in ['ì§€ë„ë¡œ ë³´ê¸°', 'ëª©ë¡ìœ¼ë¡œ ì°¾ê¸°', 'ê±°ë˜ë‚´ì—­']"
            :key="index"
            @click="setActiveDropdown('ì»¤ë®¤ë‹ˆí‹°', item)"
            :class="{ 'active-dropdown': activeDropdowns['ì»¤ë®¤ë‹ˆí‹°'] === item }"
          >
            <v-list-item-title>{{ item }}</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>

      <!-- ê°€ê²Œ ê´€ë¦¬ -->
      <v-menu open-on-click offset-y>
        <template v-slot:activator="{ props }">
          <v-btn
            text
            class="mx-1 header-menu custom-btn"
            :class="{ 'active-menu': activeMenu === 'ê°€ê²Œ ê´€ë¦¬' }"
            v-bind="props"
            @click="setActiveMenu('ê°€ê²Œ ê´€ë¦¬')"
          >
            ê°€ê²Œ ê´€ë¦¬
          </v-btn>
        </template>
        <v-list class="dropdown-list">
          <v-list-item
            v-for="(item, index) in ['MY Page', 'POS']"
            :key="index"
            @click="setActiveDropdown('ê°€ê²Œ ê´€ë¦¬', item)"
            :class="{ 'active-dropdown': activeDropdowns['ê°€ê²Œ ê´€ë¦¬'] === item }"
          >
            <v-list-item-title>{{ item }}</v-list-item-title>
          </v-list-item>
        </v-list>
      </v-menu>
    </div>

    <v-spacer></v-spacer>
    <!--
    <v-btn icon class="text-white custom-icon-btn">
      <v-icon>mdi-bell</v-icon>
    </v-btn>
    -->
    <v-menu v-model="showNotificationMenu" :close-on-content-click="false" offset-y>
      <template v-slot:activator="{ props }">
        <v-btn icon class="text-white custom-icon-btn" v-bind="props" @click="toggleMenuIfHasNotifications">
          <v-icon :key="hasUnreadNotification">
            {{ hasUnreadNotification ? "mdi-bell-alert" : "mdi-bell" }}
          </v-icon>
        </v-btn>
      </template>

      <v-list class="notification-list">
        <v-list-item v-if="notifications.length > 0 || !mariadbNotification.value" class="notification-item" @click="goToTransactions()">
          <v-list-item-title>ê±°ë˜ ìš”ì²­ì´ ì™”ìŠµë‹ˆë‹¤</v-list-item-title>
        </v-list-item>
      </v-list>
    </v-menu>

    <v-menu open-on-click offset-y>
      <template v-slot:activator="{ props }">
        <v-btn icon class="text-white custom-icon-btn" v-bind="props">
          <v-icon>mdi-dots-vertical</v-icon>
        </v-btn>
      </template>
      <v-list class="dropdown-list">
        <v-list-item @click="logout">
          <v-list-item-title>ë¡œê·¸ì•„ì›ƒ</v-list-item-title>
        </v-list-item>
      </v-list>
    </v-menu>
  </v-app-bar>
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount, reactive, computed } from "vue";
import { useRouter } from "vue-router";
import { api } from "@/api/index.js";
import { marketApi } from "../../api/MarketApi";

const router = useRouter();

const isScrolled = ref(false);
const activeMenu = ref("");
const activeDropdowns = reactive({});

const handleScroll = () => {
  if (window.scrollY > 10) {
    isScrolled.value = true;
  } else {
    isScrolled.value = false;
  }
};

const setActiveMenu = (menu) => {
  activeMenu.value = menu;
};

const logout = async () => {
  try {
    await api.getLogout();
    alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    router.push({ name: "login" });
  } catch (error) {
    console.error("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:", error);
  }
};

const goToDashboard = () => {
  router.push({ name: "dashboard" });
};

const menuRoutes = {
  "ë©”ë‰´ ê´€ë¦¬": {
    "ë©”ë‰´ ê´€ë¦¬": "MenuMain",
    "ì¹´í…Œê³ ë¦¬ ê´€ë¦¬": "MenuCategory",
    "ì˜µì…˜ ê´€ë¦¬": "MenuOption",
  },
  "ì¬ê³  ê´€ë¦¬": {
    "ì¬ê³  ì •ë³´": "InventoryMain",
    "ì¬ê³  ì…ê³ ": "InventoryRegister",
  },
  "ê°€ê²Œ ë¶„ì„": {
    "ë§¤ì¶œ ë¶„ì„": "SalesAnalysis",
    "ë©”ë‰´ ë¶„ì„": "MenuAnalysis",
    "ì¬ê³  ë¶„ì„": "InventoryAnalysis",
  },
  ì»¤ë®¤ë‹ˆí‹°: {
    "ì§€ë„ë¡œ ë³´ê¸°": "CommunityMap",
    "ëª©ë¡ìœ¼ë¡œ ì°¾ê¸°": "CommunityList",
    ê±°ë˜ë‚´ì—­: "CommunityTransactions",
  },
  "ê°€ê²Œ ê´€ë¦¬": {
    "MY Page": "MyPage",
    POS: "POSMain",
  },
};

const setActiveDropdown = (menu, item) => {
  activeDropdowns[menu] = item;
  activeMenu.value = menu;

  const routeName = menuRoutes[menu]?.[item];
  if (routeName) {
    router.push({ name: routeName });
  }
};

const showNotificationMenu = ref(false);
const notifications = ref([]); // WebSocketìœ¼ë¡œ ë°›ì€ ë©”ì‹œì§€ë“¤
let socket;
const mariadbNotification = ref(true); // ì•ˆì½ì€ ì•Œë¦¼ì´ ìˆìœ¼ë©´ false

function toggleMenuIfHasNotifications() {
  showNotificationMenu.value = hasUnreadNotification.value;
}

function goToTransactions() {
  // 1. ì•Œë¦¼ ëª©ë¡ ì´ˆê¸°í™”
  notifications.value = [];

  // 2. ì•Œë¦¼ì°½ ë‹«ê¸°
  showNotificationMenu.value = false;

  // 3. mariadbNotification ìƒíƒœ ì´ˆê¸°í™”
  mariadbNotification.value = false;

  // 4. ì•Œë¦¼ ìƒíƒœ ë³€ê²½ ìš”ì²­ (DBì— ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬)
  postNotification();

  // 5. ê±°ë˜ í˜ì´ì§€ë¡œ ì´ë™
  router.push("/transactions");
}

async function getNotification() {
  try {
    const data = await marketApi.getNotification();
    console.log(data);
    if (data !== 404) {
      mariadbNotification.value = data.data;
    } else {
      console.error("íŒë§¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    }
  } catch (error) {
    console.error("ì—ëŸ¬ ë°œìƒ:", error);
  }
}

async function postNotification() {
  try {
    const data = await marketApi.postNotification();
    console.log(data);
    if (data !== 404) {
      mariadbNotification.value = data.data;
    } else {
      console.error("íŒë§¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    }
  } catch (error) {
    console.error("ì—ëŸ¬ ë°œìƒ:", error);
  }
}

const hasUnreadNotification = computed(() => {
  console.log("ğŸ”” notifications.length =", notifications.value.length);
  console.log("ğŸ”” mariadbNotification =", mariadbNotification.value);
  return notifications.value.length > 0 || !mariadbNotification.value;
});

onMounted(() => {
  window.addEventListener("scroll", handleScroll);
  getNotification();
  const socket = new WebSocket("wss://www.wmthis.n-e.kr/ws");
  //const socket = new WebSocket("ws://localhost:5173/ws");
  socket.onopen = () => {
    console.log("âœ… WebSocket ì—°ê²°ë¨");
  };

  socket.onmessage = (event) => {
    notifications.value.push(event.data);
  };

  socket.onerror = (error) => {
    console.error("âŒ WebSocket ì˜¤ë¥˜:", error);
  };

  socket.onclose = () => {
    console.log("ğŸ”Œ WebSocket ì—°ê²° ì¢…ë£Œë¨");
  };
});

onBeforeUnmount(() => {
  if (socket && socket.readyState === WebSocket.OPEN) {
    socket.close();
  }
  window.removeEventListener("scroll", handleScroll);
});
</script>

<style scoped>
.v-app-bar {
  display: flex !important;
  position: relative !important;
  max-width: 1300px;
  border-radius: 8px;
  background-color: #708090 !important;
}

.scrolled {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.header-menu {
  font-size: 16px;
  color: #292626 !important;
  transition: color 0.3s ease;
  margin-left: 30px !important;
  font-weight: bold !important;
}

.first-menu {
  margin-left: 50px !important;
}

/* í˜¸ë²„ ë° í´ë¦­ íš¨ê³¼ ì œê±° */
.custom-btn::before {
  display: none !important;
}

.custom-btn::after {
  display: none !important;
}

.custom-btn:hover {
  background-color: transparent !important;
}

.custom-btn:active {
  background-color: transparent !important;
}

.custom-icon-btn::before {
  display: none !important;
}

.custom-icon-btn::after {
  display: none !important;
}

/* ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ë§ */
.dropdown-list {
  background-color: #708090 !important;
  border-radius: 8px;
  margin-top: 5px;
  padding: 0;
}

.v-list-item {
  min-height: 40px;
}

.v-list-item__title {
  color: #292626 !important;
  font-weight: bold;
}

.v-list-item:hover {
  background-color: rgba(255, 255, 255, 0.1) !important;
}

/* í™œì„±í™”ëœ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
.active-menu {
  color: white !important;
}

/* í™œì„±í™”ëœ ë“œë¡­ë‹¤ìš´ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
.active-dropdown .v-list-item__title {
  color: white !important;
}

.clickable-title {
  margin-left: 20px;
  cursor: pointer;
}

.logout-dropdown-list {
  background-color: #708090 !important;
  border-radius: 8px;
  margin-top: 5px;
  padding: 0;
}

.notification-list {
  max-width: 300px;
  padding: 0;
  background-color: #708090 !important;
  border-radius: 8px;
}

.notification-item {
  border-bottom: 1px solid #eee;
  padding: 8px 16px;
}

.notification-item:last-child {
  border-bottom: none;
}
</style>
